<?php
	/* -----------------------------------------------------------------------------------------
	| Generación de archivo de Quotas.
	|-------------------------------------------------------------------------------------------
	| @copyright: Achb
	| @author: ALFONSO CHAVEZ B <alfonso.chb@gmail.com>
	| @Description: Este archivo contiene todas las funciones necesarias y suficientes para 
	|               la generación del documento de Quotas de una encuesta.
	|-------------------------------------------------------------------------------------------
	*/
	

	/**
 * functiuon _survey_cygnal_download_file().
 *           Genera los links para la descarga de los difernetes archivos que se pueden generar a partir de una encuesta 
 *           Cada link, es validado para su correspondiente generación   
 */
function _survey_cygnal_download_file(){
	$quota=_survey_cygnal_download_file_quota();
	$script=_survey_cygnal_download_file_script();
	$survey=_survey_cygnal_download_file_survey();
	$toplines=_survey_cygnal_download_file_toplines();
	$crosstab=_survey_cygnal_download_file_crosstab();
	$output='<div class="alert alert-info" role="alert">You can download all the files listed below, just click on the one you want, the files are generated by independent</div>

                        <div class="list-group"> 
                          '.$crosstab.'
                          '.$toplines.'
                          '.$script.'                            
                          '.$quota.' 
                          '.$survey.'
                        </div>';
	drupal_json_output($output); 
}

function _survey_cygnal_download_file_only_quota(){
	$quota=_survey_cygnal_download_file_quota_only();
	$output='<div class="alert alert-info" role="alert">You can download all the files listed below, just click on the one you want, the files are generated by independent</div>

                        <div class="list-group">                          
                          '.$quota.'                          
                        </div>';
	drupal_json_output($output); 
}

/**
 * functiuon _survey_cygnal_download_file_quota().
 *           Obtiene la url para la descarga del archivo de quotas, en caso que tenga al menos una quota configurada para 
 *           la encuesta seleccionada   
 */
function _survey_cygnal_download_file_quota(){
	global $base_url;
	$qid=0;
	$nid=0;
	$path = drupal_get_path('module', 'survey_cygnal');
	require_once "$path/includes/survey_cygnal.db.inc";
	
	if(arg(3)=="download-file"){ #si la url contiene la palabra en esa posición, se obtiene el id de la siguiente posición
		$nid=$_POST["id"];
		if(is_numeric($nid)){#Debe llegar el id de la encuesta, y debe ser númerico			
			$data=array("survey_id"=>$nid);
	 		$qid=_survey_cygnal_db_get_quota_id($data);#Se obtiene el ultimo nid de las Quotas de la encuesta 		
	 		
		}
	}
	#Si la encuesta tiene almenos un registro de Quota asociado, le generará el link, enviando el id de la Quota
	#que se va a generar, en caso contrario no generá el link, y mostrará un mensaje
	if(is_numeric($qid) && $qid!=0){
		$ret=_survey_cygnal_download_view_status_file($nid,"quota");
		if($ret["status"]){		
			if(user_access('view quota file')){#Se verifica que el usuario tenga el permiso para descargar el archivo de Quotas
				$output='<a href="'.$base_url.'/survey/report/quota/xls/'.$qid.'/'.$nid.'" class="list-group-item"><i class="fa fa-file-excel-o fa-2x"></i> Quota file</a>';
			}else{
				$output='<div class="list-group-item" title="Ask the administrator to activate the permission to generate the quotas file if necessary"><i class="fa fa-file-excel-o fa-2x"></i> You do not have permission to generate the quotas file</div>';
			}
		}else{
			$output=$ret["msj"];
		}
	}else{
		$output='<div class="list-group-item" title="You must create a Quota record for this survey"><i class="fa fa-file-excel-o fa-2x"></i> Not found config Quota for this survey</div>';
	}
	return $output;
}

/**
 * functiuon _survey_cygnal_download_file_quota().
 *           Obtiene la url para la descarga del archivo de quotas, en caso que tenga al menos una quota configurada para 
 *           la encuesta seleccionada   
 */
function _survey_cygnal_download_file_quota_only(){
	global $base_url;
	$qid=0;
	$nid=0;
	$path = drupal_get_path('module', 'survey_cygnal');
	require_once "$path/includes/survey_cygnal.db.inc";
	
	if(arg(3)=="download-file-quota"){ #si la url contiene la palabra en esa posición, se obtiene el id de la siguiente posición
		$qid=$_POST["id"];
		$node_quota=node_load($qid);
		$nid= $node_quota->field_quota_survey[LANGUAGE_NONE][0]["nid"];		
	}
	#Si la encuesta tiene almenos un registro de Quota asociado, le generará el link, enviando el id de la Quota
	#que se va a generar, en caso contrario no generá el link, y mostrará un mensaje
	if(is_numeric($qid) && $qid!=0){
		$ret=_survey_cygnal_download_view_status_file($nid,"quota");
		if($ret["status"]){		
			if(user_access('view quota file')){#Se verifica que el usuario tenga el permiso para descargar el archivo de Quotas
				$output='<a href="'.$base_url.'/survey/report/quota/xls/'.$qid.'/'.$nid.'" class="list-group-item"><i class="fa fa-file-excel-o fa-2x"></i> Quota file</a>';
			}else{
				$output='<div class="list-group-item" title="Ask the administrator to activate the permission to generate the quotas file if necessary"><i class="fa fa-file-excel-o fa-2x"></i> You do not have permission to generate the quotas file</div>';
			}
		}else{
			$output=$ret["msj"];
		}
	}else{
		$output='<div class="list-group-item" title="You must create a Quota record for this survey"><i class="fa fa-file-excel-o fa-2x"></i> Not found config Quota for this survey</div>';
	}
	return $output;
}

/**
 * functiuon _survey_cygnal_download_file_script().
 *           Obtiene la url para la descarga del archivo de script de la encuesta  
 */
function _survey_cygnal_download_file_script(){
	global $base_url;
	$nid=0;
		
	if(arg(3)=="download-file"){ #si la url contiene la palabra en esa posición, se obtiene el id de la siguiente posición
		$nid=$_POST["id"];		
	}
	#Se valida que al menos el nid sea un valor numerico valido
	if(is_numeric($nid) && $nid!=0){
		$ret=_survey_cygnal_download_view_status_file($nid,"script");
		if($ret["status"]){		
			if(user_access('view script file')){#Se verifica que el usuario tenga el permiso para descargar el archivo de Script
				$output='<a href="'.$base_url.'/survey/report/script/doc/'.$nid.'" class="list-group-item"><i class="fa fa-file-word-o fa-2x"></i> Script file</a>';
			}else{
				$output='<div class="list-group-item" title="Ask the administrator to activate the permission to generate the script file if necessary"><i class="fa fa-file-word-o fa-2x"></i> You do not have permission to generate the script file</div>';
			}
		}else{
			$output=$ret["msj"];
		}
	}else{
		$output='<div class="list-group-item" title="Not found survey"><i class="fa fa-file-word-o fa-2x"></i> Not found survey</div>';
	}
	return $output;
}


/**
 * functiuon _survey_cygnal_download_file_survey().
 *           Obtiene la url para la descarga del archivo de pdf de la encuesta  
 */
function _survey_cygnal_download_file_survey(){
	global $base_url;
	$nid=0;
		
	if(arg(3)=="download-file"){ #si la url contiene la palabra en esa posición, se obtiene el id de la siguiente posición
		$nid=$_POST["id"];		
	}
	#Se valida que al menos el nid sea un valor numerico valido
	if(is_numeric($nid) && $nid!=0){
		$ret=_survey_cygnal_download_view_status_file($nid,"survey");
		if($ret["status"]){			
			if(user_access('view script file')){#Se verifica que el usuario tenga el permiso para descargar el archivo de Script
				$output='<a href="'.$base_url.'/survey/report/survey/pdf/'.$nid.'" class="list-group-item" target="_blank"><i class="fa fa-file-pdf-o fa-2x"></i> Survey file</a>';
			}else{
				$output='<div class="list-group-item" title="Ask the administrator to activate the permission to generate the survey file if necessary"><i class="fa fa-file-pdf-o fa-2x"></i> You do not have permission to generate the survey file</div>';
			}
		}else{
			$output=$ret["msj"];
		}
	}else{
		$output='<div class="list-group-item" title="Not found survey"><i class="fa fa-file-pdf-o fa-2x"></i> Not found survey</div>';
	}
	return $output;
}

/**
 * functiuon _survey_cygnal_download_file_script().
 *           Obtiene la url para la descarga del archivo de script de la encuesta  
 */
function _survey_cygnal_download_file_toplines(){
	global $base_url;
	$nid=0;
		
	if(arg(3)=="download-file"){ #si la url contiene la palabra en esa posición, se obtiene el id de la siguiente posición
		$nid=$_POST["id"];		
	}
	#Se valida que al menos el nid sea un valor numerico valido
	if(is_numeric($nid) && $nid!=0){
		$ret=_survey_cygnal_download_view_status_file($nid,"topline");
		if($ret["status"]){		
			if(user_access('view toplines file')){#Se verifica que el usuario tenga el permiso para descargar el archivo de Script
				$output='<a href="'.$base_url.'/survey/report/toplines/doc/'.$nid.'" class="list-group-item"><i class="fa fa-file-word-o fa-2x"></i> Toplines file</a>';
			}else{
				$output='<div class="list-group-item" title="Ask the administrator to activate the permission to generate the toplines file if necessary"><i class="fa fa-file-word-o fa-2x"></i> You do not have permission to generate the toplines file</div>';
			}
		}else{
			$output=$ret["msj"];
		}
	}else{
		$output='<div class="list-group-item" title="Not found survey"><i class="fa fa-file-word-o fa-2x"></i> Not found survey</div>';
	}
	return $output;
}

/**
 * functiuon _survey_cygnal_download_file_script().
 *           Obtiene la url para la descarga del archivo de script de la encuesta  
 */
function _survey_cygnal_download_file_crosstab(){
	global $base_url;
	$nid=0;
	

	if(arg(3)=="download-file"){ #si la url contiene la palabra en esa posición, se obtiene el id de la siguiente posición
		$nid=$_POST["id"];		
	}
	#Se valida que al menos el nid sea un valor numerico valido	
	if(is_numeric($nid) && $nid!=0){
		$ret=_survey_cygnal_download_view_status_file($nid,"crosstab");
		if($ret["status"]){

			if(user_access('view crosstab file')){#Se verifica que el usuario tenga el permiso para descargar el archivo de Croostab
				$output='<a href="'.$base_url.'/survey/report/crosstab/xls/'.$nid.'" class="list-group-item"><i class="fa fa-file-excel-o fa-2x"></i> Crosstab file</a>';
			}else{
				$output='<div class="list-group-item" title="Ask the administrator to activate the permission to generate the crosstab file if necessary"><i class="fa fa-file-excel-o fa-2x"></i> You do not have permission to generate the crosstab file</div>';
			}
		}else{
			$output=$ret["msj"];
		}
	}else{
		$output='<div class="list-group-item" title="Not found survey"><i class="fa fa-file-excel-o fa-2x"></i> Not found survey</div>';
	}
	return $output;
}

/**
 * functiuon _survey_cygnal_download_file_script().
 *           Obtiene la url para la descarga del archivo de script de la encuesta  
 */
function _survey_cygnal_download_view_status_file($nid,$type_file){
	global $base_url;
	
	$node=node_load($nid);
	
	if(isset($node->field_survey_status[LANGUAGE_NONE])){
		$id_status=$node->field_survey_status[LANGUAGE_NONE][0]["tid"];
		$term_status=taxonomy_term_load($id_status);
		$code_status=strtoupper($term_status->field_tax_survey_status_code[LANGUAGE_NONE][0]["value"]);
	}
	$fid=0;
	if(isset($node->field_survey_ss_file[LANGUAGE_NONE])){
		$fid=$node->field_survey_ss_file[LANGUAGE_NONE][0]["fid"];		
	}
	
	$return=array("status"=>"false","msj"=>"");	
	if(is_numeric($code_status)){
		switch ($code_status) {
			case 1://Created
				switch ($type_file) {
					case "topline":					
						$return["status"]=false;
						$return["msj"]='';						
						break;
					case "crosstab":					
						$return["status"]=false;
						$return["msj"]='';
						break;
					case "script":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "survey":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "quota":					
						$return["status"]=true;
						$return["msj"]='';
						break;				
				}			
				break;
			case 2://Pending
				switch ($type_file) {
					case "topline":					
						$return["status"]=false;
						$return["msj"]='';
						break;
					case "crosstab":					
						$return["status"]=false;
						$return["msj"]='';
						break;
					case "script":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "survey":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "quota":					
						$return["status"]=true;
						$return["msj"]='';
						break;				
				}		
				break;
			case 3://Review by director
				switch ($type_file) {
					case "topline":					
						$return["status"]=false;
						$return["msj"]='';
						break;
					case "crosstab":					
						$return["status"]=false;
						$return["msj"]='';
						break;
					case "script":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "survey":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "quota":					
						$return["status"]=true;
						$return["msj"]='';
						break;				
				}
				break;
			case 4://Review by consumer
				switch ($type_file) {
					case "topline":					
						$return["status"]=false;
						$return["msj"]='';
						break;
					case "crosstab":					
						$return["status"]=false;
						$return["msj"]='';
						break;
					case "script":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "survey":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "quota":					
						$return["status"]=false;
						$return["msj"]='';
						break;				
				}
				break;
			case 5://Approved
				switch ($type_file) {
					case "topline":					
						$return["status"]=false;
						$return["msj"]='';
						break;
					case "crosstab":					
						$return["status"]=false;
						$return["msj"]='';
						break;
					case "script":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "survey":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "quota":					
						$return["status"]=true;
						$return["msj"]='';
						break;				
				}
				break;
			case 6://Execution
				switch ($type_file) {
					case "topline":					
						$return["status"]=false;
						$return["msj"]='';
						break;
					case "crosstab":					
						$return["status"]=false;
						$return["msj"]='';
						break;
					case "script":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "survey":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "quota":					
						$return["status"]=true;
						$return["msj"]='';
						break;				
				}
				break;
			case 7://Completed
				switch ($type_file) {
					case "topline":					
						if($fid!=0){
							$return["status"]=true;
							$return["msj"]='';
						}else{
							$return["status"]=false;
							$return["msj"]='<div class="list-group-item" title="Not available"><i class="fa fa-file-word-o fa-2x"></i>You can not download the Toplines file without first loading the SS file</div>';
						}
						break;
					case "crosstab":					
						if($fid!=0){
							$return["status"]=true;
							$return["msj"]='';
						}else{
							$return["status"]=false;
							$return["msj"]='<div class="list-group-item" title="Not available"><i class="fa fa-file-excel-o fa-2x"></i>You can not download the Crosstab file without first loading the SS file</div>';
						}
						break;
					case "script":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "survey":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "quota":					
						$return["status"]=true;
						$return["msj"]='';
						break;				
				}
				break;
			case 8://Closed
				switch ($type_file) {
					case "topline":					
						if(is_numeric($fid)){
							$return["status"]=true;
							$return["msj"]='';
						}else{
							$return["status"]=false;
							$return["msj"]='<div class="list-group-item" title="Not available"><i class="fa fa-file-word-o fa-2x"></i>You can not download the toplines file without first loading the ss file</div>';
						}
						break;
					case "crosstab":					
						if(is_numeric($fid)){
							$return["status"]=true;
							$return["msj"]='';
						}else{
							$return["status"]=false;
							$return["msj"]='<div class="list-group-item" title="Not available"><i class="fa fa-file-excel-o fa-2x"></i>You can not download the crosstab file without first loading the ss file</div>';
						}
						break;
					case "script":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "survey":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "quota":					
						$return["status"]=true;
						$return["msj"]='';
						break;				
				}
				break;
			case 9://Pending for change
				switch ($type_file) {
					case "topline":					
						$return["status"]=false;
						$return["msj"]='';
						break;
					case "crosstab":					
						$return["status"]=false;
						$return["msj"]='';
						break;
					case "script":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "survey":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "quota":					
						$return["status"]=true;
						$return["msj"]='';
						break;				
				}
				break;
			case 10://Cancelled
				switch ($type_file) {
					case "topline":					
						$return["status"]=false;
						$return["msj"]='';
						break;
					case "crosstab":					
						$return["status"]=false;
						$return["msj"]='';
						break;
					case "script":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "survey":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "quota":					
						$return["status"]=true;
						$return["msj"]='';
						break;				
				}
				break;
			case 11://Deleted
				switch ($type_file) {
					case "topline":					
						$return["status"]=false;
						$return["msj"]='';
						break;
					case "crosstab":					
						$return["status"]=false;
						$return["msj"]='';
						break;
					case "script":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "survey":					
						$return["status"]=true;
						$return["msj"]='';
						break;
					case "quota":					
						$return["status"]=true;
						$return["msj"]='';
						break;				
				}
				break;	
		}
	}			
	return $return;
}